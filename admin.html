<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST ADMIN CONSOLE</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #0f0f0f; color: #bdc0c2; font-family: monospace; padding: 20px; }
        .admin-panel { max-width: 800px; margin: 0 auto; border: 1px solid #333; padding: 20px; }
        .report-card { background: #222; border: 1px solid #444; padding: 10px; margin-bottom: 10px; border-left: 5px solid #ff751b; }
        
        /* Input Styles */
        input, select { background: #333; border: 1px solid #555; color: #fff; padding: 8px; width: 100%; margin-bottom: 10px; border-radius: 4px; }
        label { font-size: 0.8rem; color: #888; margin-bottom: 2px; display: block; }
        
        /* Buttons */
        .btn-create { background: #007bff; color: white; border: none; padding: 10px 20px; width: 100%; margin-bottom: 20px; }
        .btn-save { background: #28a745; color: white; border: none; padding: 5px 10px; }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 5px 10px; float: right; }
    </style>
</head>
<body>

<div class="admin-panel">
    <div class="d-flex justify-content-between align-items-center">
        <h3 style="color: #ff751b;">SECRET ADMIN CONSOLE</h3>
        <a href="dashboard.html" class="btn btn-outline-light btn-sm">View Dashboard</a>
    </div>
    
    <hr style="border-color: #444;">

    <button onclick="createReport()" class="btn-create">+ CREATE NEW REPORT</button>
    
    <div id="adminFeed">Loading database...</div>
</div>

<script>
    // This is the functional code to talk to reports.js
    
    async function loadAdmin() {
        const res = await fetch("/.netlify/functions/reports");
        const data = await res.json();
        
        const container = document.getElementById("adminFeed");
        
        if(!data.reports || data.reports.length === 0) {
            container.innerHTML = "Database is empty. Click CREATE NEW REPORT.";
            return;
        }

        container.innerHTML = data.reports.map(r => `
            <div class="report-card" data-id="${r.id}">
                <button class="btn-delete" onclick="deleteReport(${r.id})">X</button>
                <label>Title</label><input type="text" data-field="title" value="${r.title}">
                <label>Source</label><input type="text" data-field="source" value="${r.source}">
                <label>Status (Active/Shutdown/Pending)</label><input type="text" data-field="status" value="${r.status}">
                <label>Type (critical/pending/secure)</label><input type="text" data-field="type" value="${r.type}">
                <label>Count</label><input type="number" data-field="reports_count" value="${r.reports_count}">
                <button class="btn-save mt-2" onclick="saveOne(${r.id})">Save Changes</button>
            </div>
        `).join("");
    }

    async function createReport() {
        const title = prompt("Enter Report Title:");
        if(!title) return;
        
        const newRep = { 
            title: title, 
            status: "ACTIVE", 
            source: "Intel", 
            type: "critical", 
            reports_count: 1 
        };
        
        await fetch('/.netlify/functions/reports', {
            method: 'POST',
            body: JSON.stringify({ data: newRep })
        });
        loadAdmin();
    }

    async function saveOne(id) {
        const card = document.querySelector(`.report-card[data-id="${id}"]`);
        const update = {
            id: id,
            title: card.querySelector('[data-field="title"]').value,
            source: card.querySelector('[data-field="source"]').value,
            status: card.querySelector('[data-field="status"]').value,
            type: card.querySelector('[data-field="type"]').value,
            reports_count: parseInt(card.querySelector('[data-field="reports_count"]').value)
        };

        await fetch('/.netlify/functions/reports', {
            method: 'POST',
            body: JSON.stringify({ data: update })
        });
        alert("Saved!");
    }

    async function deleteReport(id) {
        if(!confirm("Delete this report?")) return;
        await fetch('/.netlify/functions/reports', {
            method: 'POST',
            body: JSON.stringify({ action: 'delete', id: id })
        });
        loadAdmin();
    }

    // Initial check for authentication before loading
    async function initAuth() {
        const authRes = await fetch("/.netlify/functions/login-user");
        const auth = await authRes.json();
        if (!auth || !auth.user) { 
            alert("Admin access denied. Please log in first.");
            window.location.href = "login.html"; 
            return; 
        }
        loadAdmin();
    }

    initAuth();
</script>

</body>
</html>
