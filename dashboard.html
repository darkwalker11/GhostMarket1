<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostMarket Intel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #1c1c1c; color: #bdc0c2; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container-smooth { max-width: 900px; margin: 0 auto; padding: 20px; background-color: #262626; min-height: 100vh; border-left: 1px solid #333; border-right: 1px solid #333; }
        .report-card { background-color: #333; margin-bottom: 15px; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff; }
        .report-card.critical { border-left-color: #ff4500; }
        .report-card.pending { border-left-color: #ffc107; }
        .report-card.secure { border-left-color: #adff2f; }
        .report-title { color: #fff; font-weight: 600; font-size: 1.1rem; display: block; }
        .report-meta { font-size: 0.85rem; color: #888; margin-top: 5px; }
        .user-badge { border: 1px solid #444; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="container-smooth">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <span class="user-badge" id="userDisplay">Verifying...</span>
            <button id="logoutBtn" class="btn btn-sm btn-outline-secondary">Disconnect</button>
        </div>

        <h4>Live Intelligence Feed</h4>
        <div id="feedContainer">Loading...</div>
    </div>

    <script>
        async function init() {
            // Check Login
            const authRes = await fetch("/.netlify/functions/login-user");
            const auth = await authRes.json();
            if (!auth || !auth.user) { window.location.href = "login.html"; return; }
            document.getElementById("userDisplay").textContent = "Analyst: " + auth.user.username;

            // Load Reports
            const repRes = await fetch("/.netlify/functions/reports");
            const data = await repRes.json();
            
            const container = document.getElementById("feedContainer");
            if(!data.reports || data.reports.length === 0) { 
                container.innerHTML = "<p class='text-muted'>No active reports.</p>"; 
                return; 
            }
            
            container.innerHTML = data.reports.map(r => `
                <div class="report-card ${r.type}">
                    <span class="report-title">${r.title}</span>
                    <div class="report-meta">
                        Source: ${r.source} | Status: <strong style="text-transform:uppercase;">${r.status}</strong> | Reports: ${r.reports_count}
                    </div>
                </div>
            `).join("");
        }

        document.getElementById("logoutBtn").addEventListener("click", () => {
            document.cookie = "session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            window.location.href = "login.html";
        });

        init();
    </script>
</body>
</html>
