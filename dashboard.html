<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostMarket Intel Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        /* --- STYLES (Keep from previous step) --- */
        body { background-color: #1c1c1c; color: #bdc0c2; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container-smooth { max-width: 900px; margin: 0 auto; padding: 20px; background-color: #262626; min-height: 100vh; border-left: 1px solid #333; border-right: 1px solid #333; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #444; margin-bottom: 30px; }
        .user-badge { background-color: #333; padding: 6px 12px; border-radius: 4px; color: #adff2f; border: 1px solid #adff2f; font-size: 0.9rem; font-family: monospace; }
        .report-card { background-color: #333; margin-bottom: 15px; padding: 15px; border-radius: 4px; border-left: 4px solid #007bff; transition: background 0.2s; }
        .report-card:hover { background-color: #3d3d3d; }
        .report-card.critical { border-left-color: #ff4500; }
        .report-card.pending { border-left-color: #ffc107; }
        .report-card.secure { border-left-color: #adff2f; }
        .report-title { color: #fff; font-weight: 600; margin-bottom: 5px; display: block; }
        .report-meta { font-size: 0.8rem; color: #888; }
        .stat-box { background: #2a2a2a; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-num { font-size: 2rem; font-weight: bold; }
        .btn-edit-mode { background: #ff751b; color: white; border: none; padding: 5px 10px; margin-left: 10px; }
        /* Style for editable fields */
        [contenteditable="true"] { border: 1px dashed #007bff; padding: 2px; background: #3a3a3a; }
    </style>
</head>
<body>

    <div class="container-smooth">
        <div class="top-nav">
            <div class="d-flex align-items-center">
                <span style="display:block; font-size:0.7rem; color:#888;">CURRENT ANALYST</span>
                <span id="userWelcome" class="user-badge ml-2">Verifying...</span>
            </div>
            <div class="d-flex">
                <button id="editToggleBtn" class="btn-edit-mode btn-sm" style="display:none;">Enable Edit Mode</button>
                <button id="logoutBtn" class="btn btn-sm btn-outline-secondary ml-2">Disconnect</button>
            </div>
        </div>

        <h4>Live Intelligence Feed</h4>
        <div id="feedContainer">
            <p class="text-center">Loading intel...</p>
        </div>
    </div>

    <script>
        let reportsData = []; // Global storage for current reports
        
        // --- RENDERING & FETCHING ---

        async function init() {
            // 1. Check Login
            const authRes = await fetch("/.netlify/functions/login-user");
            const auth = await authRes.json();
            if (!auth || !auth.user) { window.location.href = "login.html"; return; }
            document.getElementById("userWelcome").textContent = auth.user.username;
            document.getElementById("editToggleBtn").style.display = 'block'; // Show Edit Button

            // 2. Fetch Reports from Database
            const repRes = await fetch("/.netlify/functions/reports");
            const data = await repRes.json();
            
            if(data.reports) {
                reportsData = data.reports;
                renderFeed(reportsData);
            }
        }

        function renderFeed(reports) {
            const container = document.getElementById("feedContainer");
            if(reports.length === 0) { container.innerHTML = "<p class='text-muted text-center'>No active reports.</p>"; return; }
            
            container.innerHTML = reports.map(r => `
                <div class="report-card ${r.type}" data-id="${r.id}" data-type="${r.type}" data-count="${r.reports_count}">
                    <span class="report-title report-field" data-field="title">${r.title}</span>
                    <div class="report-meta report-field" data-field="meta">
                        Source: <span data-field="source">${r.source}</span> | Status: <strong class="text-uppercase" data-field="status">${r.status}</strong> | Reports: <span data-field="reports_count">${r.reports_count}</span>
                    </div>
                </div>
            `).join("");
        }

        // --- EDITING LOGIC ---

        document.getElementById("editToggleBtn").addEventListener("click", toggleEditMode);

        function toggleEditMode() {
            const btn = document.getElementById("editToggleBtn");
            const isEditing = btn.textContent.includes("Save Changes");

            // Find all elements that can be edited
            const fields = document.querySelectorAll(".report-title, .report-meta strong, .report-meta span");

            if (!isEditing) {
                // ENABLE EDIT MODE
                fields.forEach(field => {
                    field.setAttribute("contenteditable", "true");
                });
                btn.textContent = "Save Changes";
                btn.style.backgroundColor = '#adff2f';
                btn.style.color = '#1c1c1c';
            } else {
                // DISABLE AND SAVE CHANGES
                saveAllReports(fields);
                fields.forEach(field => {
                    field.setAttribute("contenteditable", "false");
                });
                btn.textContent = "Enable Edit Mode";
                btn.style.backgroundColor = '#ff751b';
                btn.style.color = 'white';
            }
        }

        async function saveAllReports(fields) {
            const updatedReports = {};

            // 1. Collect all updated data into a structure keyed by Report ID
            fields.forEach(field => {
                const card = field.closest('.report-card');
                const id = card.dataset.id;
                
                if (!updatedReports[id]) {
                    // Find the original report data to ensure we send the full row back
                    const original = reportsData.find(r => r.id == id);
                    if (original) {
                        updatedReports[id] = {...original}; // Start with existing data
                    }
                }
                
                // Update the specific field text
                if (field.dataset.field === 'title') {
                    updatedReports[id].title = field.textContent.trim();
                } else if (field.dataset.field === 'status') {
                    updatedReports[id].status = field.textContent.trim();
                }
                // NOTE: More complex fields like source/count require further parsing/logic.
            });
            
            // 2. Send each updated report to the backend (reports.js)
            for (const id in updatedReports) {
                const report = updatedReports[id];
                await fetch('/.netlify/functions/reports', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ data: report })
                });
            }
            
            // 3. Reload the dashboard to show fresh data
            init(); 
        }

        // --- GLOBAL LOGIC ---
        
        document.getElementById("logoutBtn").addEventListener("click", () => {
            document.cookie = "session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            window.location.href = "login.html";
        });

        init();
    </script>
</body>
</html>
